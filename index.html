<!DOCTYPE html>
<html class="dark" lang="ko">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Marble Roulette</title>

  <!-- Favicons -->
  <link rel="apple-touch-icon" sizes="57x57" href="assets/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="assets/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="assets/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="assets/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="assets/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="assets/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="assets/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="assets/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="assets/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="assets/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
  <link rel="manifest" href="assets/manifest.json">
  <meta name="msapplication-TileColor" content="#101c22">
  <meta name="msapplication-TileImage" content="assets/ms-icon-144x144.png">
  <meta name="theme-color" content="#101c22">

  <!-- Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5899C1DJM0"></script>

  <!-- Meta -->
  <meta name="description" content="A lucky draw by dropping marbles, made by lazygyu">
  <meta property="og:url" content="https://hyunflix.github.io/roulette/">
  <meta property="og:title" content="Marble Roulette">
  <meta property="og:description" content="A lucky draw by dropping marbles, made by lazygyu">
  <meta property="og:site_name" content="hyunflix.github.io">
  <meta property="og:type" content="website">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <!-- QR Code Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#2badee",
            "primary-hover": "#45b8f0",
            "background-dark": "#101c22",
            "surface-dark": "#192b33",
            "border-dark": "#233c48",
            "text-subtle": "#92b7c9"
          },
          fontFamily: {
            "display": ["Noto Sans KR", "sans-serif"]
          }
        }
      }
    }
  </script>

  <style>
    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(146, 183, 201, 0.2); border-radius: 20px; }

    /* Range slider */
    input[type=range] { -webkit-appearance: none; background: transparent; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 16px; width: 16px;
      border-radius: 50%;
      background: #2badee;
      cursor: pointer;
      margin-top: -6px;
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%; height: 4px;
      cursor: pointer;
      background: #233c48;
      border-radius: 2px;
    }

    /* Toggle Switch - iOS Style */
    .toggle-checkbox {
      left: 4px;
      right: auto;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      transition: transform 0.2s ease, left 0.2s ease;
    }
    .toggle-checkbox:checked {
      left: calc(100% - 24px);
    }
    .toggle-label {
      background-color: #3a4a52;
      transition: background-color 0.2s ease;
    }
    .toggle-checkbox:checked + .toggle-label {
      background-color: #4ade80;
    }

    /* Sidebar collapse */
    #settings-sidebar.collapsed { width: 0; padding: 0; overflow: hidden; opacity: 0; }
    #settings-sidebar.collapsed + main #sidebar-expand { opacity: 1; pointer-events: auto; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: #192b33;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      border: 1px solid #233c48;
      z-index: 100;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    /* Game Complete Overlay */
    #gameComplete {
      position: fixed;
      inset: 0;
      z-index: 50;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(8px);
    }
    #gameComplete.show { display: flex; }

    /* Notice Modal */
    #notice {
      position: fixed;
      inset: 0;
      z-index: 60;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(8px);
    }

    /* Canvas positioning */
    #gameCanvas {
      position: fixed !important;
      top: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      left: 320px !important;
      width: calc(100vw - 320px) !important;
      height: 100vh !important;
      z-index: 5;
      transition: left 0.3s ease, width 0.3s ease;
      display: block;
    }
    body:has(#settings-sidebar.collapsed) #gameCanvas {
      left: 0 !important;
      width: 100vw !important;
    }

  </style>
</head>
<body class="bg-background-dark text-white font-display h-screen flex flex-col overflow-hidden selection:bg-primary/30">
<script type="module" src="./src/index.ts"></script>
<script type="text/javascript">
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-5899C1DJM0');

  function getNames() {
    const value = document.querySelector('#in_names').value.trim();
    return value.split(/[,\r\n]/g).map(v => v.trim()).filter(v => !!v);
  }

  function parseName(nameStr) {
    const weightRegex = /(\/\d+)/;
    const countRegex = /(\*\d+)/;
    const hasWeight = weightRegex.test(nameStr);
    const hasCount = countRegex.test(nameStr);
    const name = /^\s*([^\/*]+)?/.exec(nameStr)[1];
    const weight = hasWeight ? parseInt(weightRegex.exec(nameStr)[1].replace('/', '')) : 1;
    const count = hasCount ? parseInt(countRegex.exec(nameStr)[1].replace('*', '')) : 1;
    return { name, weight, count };
  }

  function updateParticipantCount() {
    const names = getNames();
    let totalCount = 0;
    names.forEach(nameStr => {
      const parsed = parseName(nameStr);
      totalCount += parsed.count;
    });
    const countEl = document.querySelector('#participantCount');
    const hudCountEl = document.querySelector('#hudPlayerCount');
    if (countEl) countEl.textContent = totalCount;
    if (hudCountEl) hudCountEl.textContent = `${totalCount} Players`;
  }

  function getReady() {
    const names = getNames();
    window.roulette.setMarbles(names);
    ready = names.length > 0;
    localStorage.setItem('mbr_names', names.join(','));
    updateParticipantCount();
    switch (winnerType) {
      case 'first':
        setWinnerRank(1);
        break;
      case 'last':
        const total = window.roulette.getCount();
        setWinnerRank(total);
        break;
    }
  }

  function setWinnerRank(rank) {
    document.querySelector('#in_winningRank').value = rank;
    window.options.winningRank = rank - 1;
    window.roulette.setWinningRank(window.options.winningRank);
  }

  let ready = false;
  let winnerType = 'first';

  document.addEventListener('DOMContentLoaded', () => {
    initialize();
  });

  function initialize() {
    if (!window.roulette || !window.roulette.isReady) {
      setTimeout(initialize, 100);
      return;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const namesFromUrl = urlParams.get('names');

    if (namesFromUrl) {
      document.querySelector('#in_names').value = namesFromUrl.replace(/,/g, '\n');
    } else {
      const savedNames = localStorage.getItem('mbr_names');
      if (savedNames) {
        document.querySelector('#in_names').value = savedNames;
      }
    }

    document.querySelector('#in_names').addEventListener('input', () => {
      getReady();
    });

    document.querySelector('#in_names').addEventListener('blur', () => {
      const nameSource = getNames();
      const nameSet = new Set();
      const nameCounts = {};
      nameSource.forEach(nameSrc => {
        const name = parseName(nameSrc);
        const key = name.weight > 1 ? `${name.name}/${name.weight}` : name.name;
        if (!nameSet.has(key)) {
          nameSet.add(key);
          nameCounts[key] = 0;
        }
        nameCounts[key] += name.count;
      });
      const result = [];
      Object.keys(nameCounts).forEach(key => {
        if (nameCounts[key] > 1) {
          result.push(`${key}*${nameCounts[key]}`);
        } else {
          result.push(key);
        }
      });
      const oldValue = document.querySelector('#in_names').value;
      const newValue = result.join('\n');
      if (oldValue !== newValue) {
        document.querySelector('#in_names').value = newValue;
        getReady();
      }
    });

    // Shuffle button
    document.querySelector('#btnShuffle').addEventListener('click', () => {
      getReady();
      if (window.SoundManager) window.SoundManager.play('click');
    });

    // Start button
    document.querySelector('#btnStart').addEventListener('click', () => {
      if (!ready) return;
      if (window.SoundManager) window.SoundManager.play('start');
      gtag && gtag('event', 'start', {
        'event_category': 'roulette',
        'event_label': 'start',
        'value': window.roulette.getCount(),
      });
      window.roulette.start();
      document.querySelector('#settings-sidebar').classList.add('collapsed');
      document.querySelector('#hudStatus').textContent = 'Racing...';
    });

    // Restart button
    document.querySelector('#btnRestart').addEventListener('click', () => {
      window.roulette.reset();
      getReady();
      document.querySelector('#gameComplete').classList.remove('show');
      document.querySelector('#hudStatus').textContent = 'Ready to Race';
    });

    // Clear all button
    document.querySelector('#btnClearAll').addEventListener('click', () => {
      document.querySelector('#in_names').value = '';
      getReady();
    });

    // Toggle switches
    document.querySelector('#toggle-skills').addEventListener('change', (e) => {
      window.options.useSkills = e.target.checked;
    });

    document.querySelector('#toggle-record').addEventListener('change', (e) => {
      window.options.autoRecording = e.target.checked;
      window.roulette.setAutoRecording(e.target.checked);
    });

    // Winner selection buttons
    const updateWinnerButtons = () => {
      const btnFirst = document.querySelector('#btn-first');
      const btnLast = document.querySelector('#btn-last');
      const rankInput = document.querySelector('#in_winningRank');

      // Reset all buttons
      btnFirst.className = 'flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-colors bg-surface-dark border border-border-dark text-white hover:bg-border-dark';
      btnLast.className = 'flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-colors bg-surface-dark border border-border-dark text-white hover:bg-border-dark';
      rankInput.className = 'w-16 h-9 px-2 rounded-lg text-sm text-white bg-surface-dark border border-border-dark focus:outline-0 focus:ring-2 focus:ring-primary/50 focus:border-primary text-center';

      // Highlight active selection
      if (winnerType === 'first') {
        btnFirst.className = 'flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-colors bg-primary text-[#111c22]';
      } else if (winnerType === 'last') {
        btnLast.className = 'flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-colors bg-primary text-[#111c22]';
      } else {
        rankInput.className = 'w-16 h-9 px-2 rounded-lg text-sm text-white bg-primary/20 border-2 border-primary focus:outline-0 focus:ring-2 focus:ring-primary/50 text-center';
      }
    };

    document.querySelector('#btn-first').addEventListener('click', () => {
      winnerType = 'first';
      setWinnerRank(1);
      updateWinnerButtons();
    });

    document.querySelector('#btn-last').addEventListener('click', () => {
      winnerType = 'last';
      const total = window.roulette.getCount();
      setWinnerRank(total > 0 ? total : 1);
      updateWinnerButtons();
    });

    document.querySelector('#in_winningRank').addEventListener('change', (e) => {
      const v = parseInt(e.target.value, 10);
      winnerType = 'custom';
      setWinnerRank(isNaN(v) || v < 1 ? 1 : v);
      updateWinnerButtons();
    });

    document.querySelector('#in_winningRank').addEventListener('focus', () => {
      winnerType = 'custom';
      updateWinnerButtons();
    });

    // Volume slider
    document.querySelector('#masterVolume').addEventListener('input', (e) => {
      const val = e.target.value;
      document.querySelector('#masterVolumeValue').textContent = `${val}%`;
      if (window.SoundManager) {
        window.SoundManager.volume = val / 100;
      }
    });

    // Speed slider
    document.querySelector('#gameSpeed').addEventListener('input', (e) => {
      const val = parseInt(e.target.value);
      const speed = val / 100;
      document.querySelector('#gameSpeedValue').textContent = `${speed.toFixed(1)}x`;
      if (window.roulette) {
        window.roulette.setSpeed(speed);
      }
      localStorage.setItem('mbr_speed', val.toString());
    });

    // Initialize speed from localStorage
    const savedSpeed = localStorage.getItem('mbr_speed');
    if (savedSpeed) {
      const val = parseInt(savedSpeed);
      document.querySelector('#gameSpeed').value = val;
      document.querySelector('#gameSpeedValue').textContent = `${(val / 100).toFixed(1)}x`;
      if (window.roulette) {
        window.roulette.setSpeed(val / 100);
      }
    }

    // Initialize sound from localStorage
    const savedSound = localStorage.getItem('mbr_sound');
    if (savedSound === 'off' && window.SoundManager) {
      window.SoundManager.enabled = false;
      document.querySelector('#masterVolume').value = 0;
      document.querySelector('#masterVolumeValue').textContent = '0%';
    }

    // Theme handling
    const initTheme = () => {
      const savedTheme = localStorage.getItem('mbr_theme');
      let isDark = true;
      if (savedTheme) {
        isDark = savedTheme === 'dark';
      } else {
        isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      }
      document.documentElement.classList.toggle('dark', isDark);
      document.querySelector('#toggle-darkmode').checked = isDark;
      window.roulette.setTheme(isDark ? 'dark' : 'light');
    };
    initTheme();

    // Dark mode toggle
    document.querySelector('#toggle-darkmode').addEventListener('change', (e) => {
      const isDark = e.target.checked;
      document.documentElement.classList.toggle('dark', isDark);
      window.roulette.setTheme(isDark ? 'dark' : 'light');
      localStorage.setItem('mbr_theme', isDark ? 'dark' : 'light');
    });

    // Winner determination events
    window.roulette.addEventListener('goal', (e) => {
      ready = false;
      if (window.SoundManager) window.SoundManager.play('goal');
      document.querySelector('#hudStatus').textContent = 'Winner!';
    });

    window.roulette.addEventListener('finish', (e) => {
      const winnerName = e.detail?.winner || '???';
      document.querySelector('#winnerName').textContent = winnerName;
      document.querySelector('#gameComplete').classList.add('show');
      if (window.VictoryAnimation) {
        window.VictoryAnimation.play();
        window.VictoryAnimation.confetti();
      }
      if (window.SoundManager) window.SoundManager.play('finish');
      setTimeout(() => {
        document.querySelector('#settings-sidebar').classList.remove('collapsed');
      }, 1000);
    });

    // Collision sounds
    window.roulette.setCollisionCallback((impulse) => {
      if (window.SoundManager) {
        const intensity = Math.min(1, (impulse - 1.5) / 8);
        window.SoundManager.play('collision', intensity);
      }
    });

    // Close completion overlay
    document.querySelector('#closeComplete').addEventListener('click', () => {
      if (window.VictoryAnimation) window.VictoryAnimation.hide();
      setTimeout(() => {
        document.querySelector('#gameComplete').classList.remove('show');
      }, 200);
    });

    // Message toast
    window.roulette.addEventListener('message', (e) => {
      simpleToast(e.detail);
    });

    // Initialize
    document.querySelector('#btnShuffle').click();

    // Map selector
    const maps = window.roulette.getMaps();
    const mapSelector = document.querySelector('#sltMap');
    maps.forEach((map) => {
      const option = document.createElement('option');
      option.value = map.index;
      option.innerHTML = map.title;
      mapSelector.append(option);
    });
    mapSelector.addEventListener('change', (e) => {
      window.roulette.setMap(e.target.value);
    });

    // Rank list update
    const rankList = document.querySelector('#rankList');
    const rankCount = document.querySelector('#rankCount');

    const updateRankList = () => {
      if (!window.roulette || !window.roulette.getRankings) return;
      const data = window.roulette.getRankings();
      rankCount.textContent = `${data.finished} / ${data.total}`;

      let html = '';
      data.winners.forEach(m => {
        const icon = m.isWinner ? 'emoji_events' : 'check_circle';
        const winnerClass = m.isWinner ? 'text-yellow-400' : 'text-green-400';
        html += `<div class="flex items-center gap-2 py-1.5 px-2 ${m.isWinner ? 'bg-yellow-500/10 rounded' : ''}">
          <span class="text-xs text-text-subtle w-6">#${m.rank}</span>
          <span class="flex-1 text-sm truncate" style="color: hsl(${m.hue}, 80%, 65%)">${m.name}</span>
          <span class="material-symbols-outlined text-sm ${winnerClass}">${icon}</span>
        </div>`;
      });
      data.marbles.forEach(m => {
        html += `<div class="flex items-center gap-2 py-1.5 px-2 opacity-50">
          <span class="text-xs text-text-subtle w-6">#${m.rank}</span>
          <span class="flex-1 text-sm truncate" style="color: hsl(${m.hue}, 80%, 65%)">${m.name}</span>
        </div>`;
      });
      rankList.innerHTML = html;
    };
    setInterval(updateRankList, 100);

    // Sidebar toggle
    document.querySelector('#btnCollapse').addEventListener('click', () => {
      document.querySelector('#settings-sidebar').classList.add('collapsed');
    });
    document.querySelector('#sidebar-expand').addEventListener('click', () => {
      document.querySelector('#settings-sidebar').classList.remove('collapsed');
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;

      switch (e.key) {
        case 'Enter':
        case ' ':
          e.preventDefault();
          if (ready) document.querySelector('#btnStart').click();
          break;
        case 'r':
        case 'R':
          if (!e.ctrlKey && !e.metaKey) {
            e.preventDefault();
            document.querySelector('#btnShuffle').click();
          }
          break;
        case 'Escape':
          e.preventDefault();
          if (document.querySelector('#gameComplete').classList.contains('show')) {
            document.querySelector('#closeComplete').click();
          } else {
            document.querySelector('#settings-sidebar').classList.toggle('collapsed');
          }
          break;
        case 'f':
        case 'F':
          if (!e.ctrlKey && !e.metaKey) {
            e.preventDefault();
            if (document.fullscreenElement) {
              document.exitFullscreen();
            } else {
              document.documentElement.requestFullscreen();
            }
          }
          break;
        case 's':
        case 'S':
          if (!e.ctrlKey && !e.metaKey) {
            e.preventDefault();
            document.querySelector('#settings-sidebar').classList.toggle('collapsed');
          }
          break;
      }
    });

    // Notice modal
    document.querySelector('#btnHelp').addEventListener('click', () => {
      document.querySelector('#notice').style.display = 'flex';
    });
    document.querySelector('#closeNotice').addEventListener('click', () => {
      document.querySelector('#notice').style.display = 'none';
    });

    function simpleToast(msg) {
      const toast = document.createElement('div');
      toast.classList.add('toast');
      toast.innerHTML = msg;
      document.body.appendChild(toast);
      setTimeout(() => document.body.removeChild(toast), 1200);
    }

    // Room Management
    let currentRoomCode = null;
    let liveParticipants = [];

    const manualInputMode = document.querySelector('#manualInputMode');
    const roomMode = document.querySelector('#roomMode');
    const roomCodeDisplay = document.querySelector('#roomCodeDisplay');
    const qrCodeContainer = document.querySelector('#qrCodeContainer');
    const liveParticipantList = document.querySelector('#liveParticipantList');
    const liveParticipantCount = document.querySelector('#liveParticipantCount');

    // Create Room
    document.querySelector('#btnCreateRoom').addEventListener('click', async () => {
      if (!window.roomService) {
        simpleToast('Firebase ì—°ê²° ì¤‘...');
        return;
      }

      try {
        const roomCode = await window.roomService.createRoom();
        currentRoomCode = roomCode;

        // Show room mode
        manualInputMode.classList.add('hidden');
        roomMode.classList.remove('hidden');
        roomCodeDisplay.textContent = roomCode;

        // Generate QR Code
        const joinUrl = `${window.location.origin}${window.location.pathname.replace('index.html', '')}join.html?room=${roomCode}`;
        qrCodeContainer.innerHTML = '';

        if (window.QRCode) {
          const canvas = document.createElement('canvas');
          QRCode.toCanvas(canvas, joinUrl, {
            width: 160,
            margin: 2,
            color: { dark: '#2badee', light: '#101c22' }
          });
          qrCodeContainer.appendChild(canvas);
        }

        // Listen for participants
        window.roomService.onParticipantsChange(roomCode, (participants) => {
          liveParticipants = participants;
          updateLiveParticipantList();
        });

        simpleToast('ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
      } catch (error) {
        console.error('Room creation error:', error);
        simpleToast('ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // Update live participant list
    function updateLiveParticipantList() {
      liveParticipantCount.textContent = `${liveParticipants.length}ëª…`;

      if (liveParticipants.length === 0) {
        liveParticipantList.innerHTML = '<p class="text-xs text-text-subtle text-center py-4">ì°¸ê°€ìë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>';
        return;
      }

      let html = '';
      liveParticipants.forEach((p, i) => {
        html += `<div class="flex items-center gap-2 py-1 px-2 rounded hover:bg-border-dark/50">
          <span class="w-5 h-5 rounded-full bg-primary/20 text-primary text-xs flex items-center justify-center">${i + 1}</span>
          <span class="flex-1 text-sm text-white truncate">${p.name}</span>
          <button onclick="removeParticipant('${p.id}')" class="text-text-subtle hover:text-red-400 transition-colors">
            <span class="material-symbols-outlined text-sm">close</span>
          </button>
        </div>`;
      });
      liveParticipantList.innerHTML = html;
    }

    // Remove participant
    window.removeParticipant = async (participantId) => {
      if (currentRoomCode && window.roomService) {
        await window.roomService.removeParticipant(currentRoomCode, participantId);
      }
    };

    // Apply participants to game
    document.querySelector('#btnApplyParticipants').addEventListener('click', () => {
      if (liveParticipants.length === 0) {
        simpleToast('ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const names = liveParticipants.map(p => p.name);
      document.querySelector('#in_names').value = names.join('\n');
      getReady();
      simpleToast(`${names.length}ëª…ì˜ ì°¸ê°€ìê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!`);
    });

    // Close room
    document.querySelector('#btnCloseRoom').addEventListener('click', async () => {
      if (currentRoomCode && window.roomService) {
        window.roomService.stopListening();
        await window.roomService.deleteRoom(currentRoomCode);
      }

      currentRoomCode = null;
      liveParticipants = [];

      // Show manual input mode
      roomMode.classList.add('hidden');
      manualInputMode.classList.remove('hidden');
      qrCodeContainer.innerHTML = '';

      simpleToast('ë°©ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.');
    });
  }
</script>

<!-- Main Layout -->
<div class="flex h-full w-full">
  <!-- Sidebar -->
  <aside id="settings-sidebar" class="w-80 h-full flex flex-col border-r border-border-dark bg-[#111c22] z-20 transition-all duration-300 ease-in-out relative flex-shrink-0">
    <!-- App Title -->
    <div class="px-6 pt-6 pb-4 border-b border-border-dark shrink-0">
      <h1 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-red-500 to-pink-500 mb-1">
        MARBLE RUSH
      </h1>
      <p class="text-xs uppercase tracking-widest text-gray-400">
        Extreme Physics Edition
      </p>
    </div>

    <!-- Sidebar Header -->
    <div class="h-12 flex items-center justify-between px-6 border-b border-border-dark shrink-0">
      <h2 class="text-base font-bold text-white">Settings</h2>
      <button id="btnCollapse" class="text-text-subtle hover:text-white transition-colors" aria-label="Collapse sidebar">
        <span class="material-symbols-outlined">menu_open</span>
      </button>
    </div>

    <!-- Scrollable Content -->
    <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-6">
      <!-- Action Buttons -->
      <div class="space-y-3">
        <button id="btnStart" class="flex w-full cursor-pointer items-center justify-center rounded-lg h-12 px-5 bg-primary hover:bg-primary-hover transition-colors text-[#111c22] text-base font-bold shadow-lg shadow-primary/20">
          <span class="material-symbols-outlined mr-2">play_arrow</span>
          <span>Start Game</span>
        </button>
        <div class="flex gap-3">
          <button id="btnRestart" class="flex flex-1 cursor-pointer items-center justify-center rounded-lg h-10 px-3 bg-surface-dark border border-border-dark hover:bg-border-dark transition-colors text-white text-sm font-bold">
            <span class="material-symbols-outlined text-lg mr-1.5">refresh</span>
            <span>Restart</span>
          </button>
          <button id="btnShuffle" class="flex flex-1 cursor-pointer items-center justify-center rounded-lg h-10 px-3 bg-surface-dark border border-border-dark hover:bg-border-dark transition-colors text-white text-sm font-bold">
            <span class="material-symbols-outlined text-lg mr-1.5">shuffle</span>
            <span>Shuffle</span>
          </button>
        </div>
      </div>

      <!-- Participants Input -->
      <div class="space-y-2">
        <div class="flex items-center justify-between">
          <label class="block text-white text-base font-medium">Participants</label>
          <button id="btnCreateRoom" class="flex items-center gap-1 text-xs text-primary hover:text-primary-hover transition-colors">
            <span class="material-symbols-outlined text-sm">qr_code_2</span>
            <span>ë°© ë§Œë“¤ê¸°</span>
          </button>
        </div>

        <!-- Manual Input Mode -->
        <div id="manualInputMode">
          <textarea id="in_names" class="flex w-full resize-none rounded-lg text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-dark bg-surface-dark focus:border-primary min-h-[140px] placeholder:text-text-subtle p-4 text-sm leading-relaxed custom-scrollbar" placeholder="Enter names...
Alice
Bob
Charlie"></textarea>
          <div class="flex justify-between items-center text-xs text-text-subtle mt-2">
            <span>Total: <span id="participantCount">0</span></span>
            <button id="btnClearAll" class="hover:text-primary transition-colors">Clear All</button>
          </div>
        </div>

        <!-- Room Mode -->
        <div id="roomMode" class="hidden space-y-3">
          <!-- Room Info -->
          <div class="bg-background-dark rounded-xl p-4 text-center">
            <p class="text-xs text-text-subtle mb-2">ë°© ì½”ë“œ</p>
            <p id="roomCodeDisplay" class="text-2xl font-bold tracking-widest text-primary mb-3">------</p>
            <div id="qrCodeContainer" class="flex justify-center mb-3"></div>
            <p class="text-xs text-text-subtle">QRì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬ ì°¸ê°€</p>
          </div>

          <!-- Live Participants -->
          <div class="bg-surface-dark rounded-xl border border-border-dark">
            <div class="flex items-center justify-between px-3 py-2 border-b border-border-dark">
              <span class="text-sm font-medium text-white">ì°¸ê°€ì</span>
              <span id="liveParticipantCount" class="text-xs text-text-subtle">0ëª…</span>
            </div>
            <div id="liveParticipantList" class="max-h-32 overflow-y-auto custom-scrollbar p-2">
              <p class="text-xs text-text-subtle text-center py-4">ì°¸ê°€ìë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
            </div>
          </div>

          <!-- Room Actions -->
          <div class="flex gap-2">
            <button id="btnApplyParticipants" class="flex-1 py-2 px-3 rounded-lg text-sm font-medium bg-primary text-background-dark hover:bg-primary-hover transition-colors">
              ì ìš©í•˜ê¸°
            </button>
            <button id="btnCloseRoom" class="py-2 px-3 rounded-lg text-sm font-medium bg-surface-dark border border-border-dark text-white hover:bg-border-dark transition-colors">
              ë°© ë‹«ê¸°
            </button>
          </div>
        </div>
      </div>

      <!-- Configuration -->
      <div class="space-y-3 pt-3 border-t border-border-dark/50">
        <!-- Map Selection -->
        <div class="flex items-center justify-between">
          <span class="text-white text-sm">Map</span>
          <div class="relative w-40">
            <select id="sltMap" class="appearance-none w-full rounded-lg text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-border-dark bg-surface-dark focus:border-primary h-9 px-3 text-sm cursor-pointer">
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-text-subtle">
              <span class="material-symbols-outlined text-lg">expand_more</span>
            </div>
          </div>
        </div>

        <!-- Skills -->
        <div class="flex items-center justify-between">
          <span class="text-white text-sm">Skills</span>
          <div class="relative inline-block w-12 h-7 select-none">
            <input type="checkbox" id="toggle-skills" checked class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white appearance-none cursor-pointer top-1 z-10">
            <label class="toggle-label block h-7 rounded-full cursor-pointer transition-colors duration-200" for="toggle-skills"></label>
          </div>
        </div>

        <!-- Winner Selection -->
        <div class="flex items-center justify-between">
          <span class="text-white text-sm">Winner</span>
          <div class="flex gap-1.5">
            <button id="btn-first" class="py-1.5 px-3 rounded-lg text-xs font-medium transition-colors bg-primary text-[#111c22]">First</button>
            <button id="btn-last" class="py-1.5 px-3 rounded-lg text-xs font-medium transition-colors bg-surface-dark border border-border-dark text-white hover:bg-border-dark">Last</button>
            <div class="flex items-center gap-0.5">
              <input type="number" id="in_winningRank" value="1" min="1" class="w-12 h-7 px-1 rounded-lg text-xs text-white bg-surface-dark border border-border-dark focus:outline-0 focus:ring-2 focus:ring-primary/50 focus:border-primary text-center">
              <span class="text-xs text-text-subtle">th</span>
            </div>
          </div>
        </div>

        <!-- Auto Record -->
        <div class="flex items-center justify-between">
          <span class="text-white text-sm">Auto-Record</span>
          <div class="relative inline-block w-12 h-7 select-none">
            <input type="checkbox" id="toggle-record" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white appearance-none cursor-pointer top-1 z-10">
            <label class="toggle-label block h-7 rounded-full cursor-pointer transition-colors duration-200" for="toggle-record"></label>
          </div>
        </div>

        <!-- Speed -->
        <div class="flex items-center justify-between gap-3">
          <span class="text-white text-sm shrink-0">Speed</span>
          <input id="gameSpeed" type="range" min="50" max="300" value="100" class="flex-1 h-2 rounded-lg cursor-pointer">
          <span id="gameSpeedValue" class="text-xs text-text-subtle w-10 text-right">1.0x</span>
        </div>

        <!-- Volume -->
        <div class="flex items-center justify-between gap-3">
          <span class="text-white text-sm shrink-0">Volume</span>
          <input id="masterVolume" type="range" min="0" max="100" value="80" class="flex-1 h-2 rounded-lg cursor-pointer">
          <span id="masterVolumeValue" class="text-xs text-text-subtle w-8 text-right">80%</span>
        </div>

        <!-- Dark Mode -->
        <div class="flex items-center justify-between">
          <span class="text-white text-sm">Dark Mode</span>
          <div class="relative inline-block w-12 h-7 select-none">
            <input type="checkbox" id="toggle-darkmode" checked class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white appearance-none cursor-pointer top-1 z-10">
            <label class="toggle-label block h-7 rounded-full cursor-pointer transition-colors duration-200" for="toggle-darkmode"></label>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="p-4 border-t border-border-dark flex items-center justify-between text-xs text-text-subtle bg-surface-dark/50">
      <span>v1.0.4</span>
      <button id="btnHelp" class="hover:text-primary transition-colors flex items-center gap-1">
        <span class="material-symbols-outlined text-sm">help</span>
        <span>Help</span>
      </button>
    </div>
  </aside>

  <!-- Main Content Area -->
  <main class="flex-1 relative flex flex-col overflow-hidden pointer-events-none" style="z-index: 10; background: transparent;">
    <!-- Expand Sidebar Button (visible when collapsed) -->
    <button id="sidebar-expand" class="absolute top-4 left-4 z-50 opacity-0 pointer-events-auto transition-opacity bg-surface-dark/90 backdrop-blur border border-border-dark p-2 rounded-lg hover:bg-border-dark">
      <span class="material-symbols-outlined text-white">menu</span>
    </button>

    <!-- Game HUD -->
    <div class="absolute top-0 left-0 right-0 z-40 p-6 flex justify-between items-start">
      <!-- Status Badge -->
      <div class="bg-surface-dark/90 backdrop-blur-sm border border-border-dark px-4 py-2 rounded-full flex items-center gap-2 shadow-lg pointer-events-auto">
        <span class="relative flex h-2.5 w-2.5">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-primary"></span>
        </span>
        <span id="hudStatus" class="text-sm font-bold text-white tracking-wide uppercase">Ready to Race</span>
      </div>

      <!-- Player Counter -->
      <div class="bg-surface-dark/90 backdrop-blur-sm border border-border-dark px-4 py-2 rounded-full flex items-center gap-2 shadow-lg pointer-events-auto">
        <span class="material-symbols-outlined text-primary text-sm">groups</span>
        <span id="hudPlayerCount" class="text-sm font-bold text-white">0 Players</span>
      </div>
    </div>

    <!-- Rank List Overlay -->
    <div id="rankOverlay" class="absolute top-20 right-6 z-40 w-56 bg-surface-dark/90 backdrop-blur-sm border border-border-dark rounded-lg shadow-lg overflow-hidden pointer-events-auto">
      <div class="flex items-center justify-between px-3 py-2 border-b border-border-dark bg-surface-dark">
        <span class="text-sm font-bold text-white">Rankings</span>
        <span id="rankCount" class="text-xs text-text-subtle">0 / 0</span>
      </div>
      <div id="rankList" class="max-h-64 overflow-y-auto custom-scrollbar"></div>
    </div>

  </main>
</div>

<!-- Game Complete Overlay -->
<div id="gameComplete">
  <div class="text-center space-y-6 bg-surface-dark/95 backdrop-blur border border-border-dark rounded-2xl p-8 shadow-2xl max-w-sm mx-4">
    <div class="text-6xl">ğŸ†</div>
    <div>
      <h2 class="text-2xl font-bold text-white mb-2">ì¶”ì²¨ ì™„ë£Œ!</h2>
      <p class="text-text-subtle text-sm">ë‹¹ì²¨ì</p>
    </div>
    <div class="bg-gradient-to-r from-primary/20 to-purple-500/20 border border-primary/30 rounded-xl py-4 px-6">
      <span id="winnerName" class="text-2xl font-bold text-white"></span>
    </div>
    <button id="closeComplete" class="w-full bg-primary hover:bg-primary-hover text-[#111c22] font-bold py-3 px-6 rounded-lg transition-colors">
      í™•ì¸
    </button>
  </div>
</div>

<!-- Help Modal -->
<div id="notice">
  <div class="bg-surface-dark border border-border-dark rounded-2xl p-6 max-w-lg mx-4 shadow-2xl">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold text-white">ì´ìš©ë°©ë²•</h2>
      <button id="closeNotice" class="text-text-subtle hover:text-white transition-colors">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="space-y-4 text-sm text-text-subtle max-h-96 overflow-y-auto custom-scrollbar pr-2">
      <div>
        <h3 class="font-bold text-white mb-2">1. ì°¸ê°€ì ì…ë ¥</h3>
        <p>ì„¤ì • íŒ¨ë„ì˜ í…ìŠ¤íŠ¸ ì˜ì—­ì— ì°¸ê°€ì ì´ë¦„ì„ ì…ë ¥í•©ë‹ˆë‹¤.</p>
        <ul class="list-disc list-inside mt-1 space-y-1">
          <li>ì‰¼í‘œ(,) ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„</li>
          <li><code class="bg-border-dark px-1 rounded">ì´ë¦„*ìˆ«ì</code>: ê°™ì€ ì´ë¦„ì˜ ë§ˆë¸” ì—¬ëŸ¬ ê°œ</li>
          <li><code class="bg-border-dark px-1 rounded">ì´ë¦„/ìˆ«ì</code>: ë§ˆë¸” í¬ê¸° ì¡°ì ˆ</li>
        </ul>
      </div>
      <div>
        <h3 class="font-bold text-white mb-2">2. ì˜µì…˜ ì„¤ì •</h3>
        <ul class="list-disc list-inside space-y-1">
          <li><strong>ë§µ</strong>: ë‹¤ì–‘í•œ ë§µ í…Œë§ˆ ì„ íƒ</li>
          <li><strong>ìŠ¤í‚¬</strong>: ë§ˆë¸”ì´ ì£¼ë³€ì„ ë°€ì–´ë‚´ëŠ” ëŠ¥ë ¥</li>
          <li><strong>ë…¹í™”</strong>: ê²°ê³¼ë¥¼ ìë™ìœ¼ë¡œ ë…¹í™”</li>
        </ul>
      </div>
      <div>
        <h3 class="font-bold text-white mb-2">3. í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤</h3>
        <ul class="list-disc list-inside space-y-1">
          <li><code class="bg-border-dark px-1 rounded">Space/Enter</code>: ê²Œì„ ì‹œì‘</li>
          <li><code class="bg-border-dark px-1 rounded">R</code>: ìˆœì„œ ì…”í”Œ</li>
          <li><code class="bg-border-dark px-1 rounded">S</code>: ì„¤ì • íŒ¨ë„ í† ê¸€</li>
          <li><code class="bg-border-dark px-1 rounded">F</code>: ì „ì²´í™”ë©´</li>
          <li><code class="bg-border-dark px-1 rounded">Esc</code>: ë‹«ê¸°</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Copyright -->
<div class="fixed bottom-4 right-4 z-20 text-xs text-text-subtle/50 pointer-events-none">
  Â© 2025 HYUNFLIX. All Rights Reserved.
</div>

</body>
</html>
